package com.rabhareit.tailing.service;

import com.rabhareit.tailing.entity.TailingSocialUser;
import com.rabhareit.tailing.repository.TailingSocialUserRepository;
import org.apache.commons.lang3.RandomStringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.authority.AuthorityUtils;
import org.springframework.social.connect.Connection;
import org.springframework.social.connect.ConnectionSignUp;
import org.springframework.social.connect.UserProfile;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;


@Component
@Transactional
public class ConnectionSignUpImpl implements ConnectionSignUp {

    @Autowired
    TailingSocialUserRepository socialUserRepository;

    /*
    * Socialログイン時のユーザー追加(自システムのDBに)
    * user id(@~~~)でログインしてもらう.
    * -> username = userid(@~~~)
    * */
    @Override
    public String execute(Connection<?> connection) {
      UserProfile profile = connection.fetchUserProfile();
      String username = profile.getUsername();

      //ここで発行された初期パスワードを通知して後で変えてもらう。
      TailingSocialUser newUser = new TailingSocialUser(profile.getUsername(), RandomStringUtils.random(10,true,true), AuthorityUtils.createAuthorityList("ROLE_USER"));
      return username;
    }
}
